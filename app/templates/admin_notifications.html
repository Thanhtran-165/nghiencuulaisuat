{% extends "base.html" %}

{% block title %}Notification Channels - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Notification Channels</h2>
            <p class="text-muted">Configure email and webhook notifications for alerts</p>

            <!-- Add Channel Buttons -->
            <div class="mb-3">
                <button class="btn btn-primary" data-toggle="modal" data-target="#addEmailModal">
                    <i class="fas fa-envelope"></i> Add Email Channel
                </button>
                <button class="btn btn-primary" data-toggle="modal" data-target="#addWebhookModal">
                    <i class="fas fa-link"></i> Add Webhook Channel
                </button>
                <button class="btn btn-secondary" onclick="loadChannels()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Channels Table -->
            <div class="card">
                <div class="card-header">
                    <h5>Configured Channels</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="channels-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Enabled</th>
                                    <th>Config</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Notification Events -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Recent Notification Events</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm" id="events-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Alert Code</th>
                                    <th>Channel Type</th>
                                    <th>Status</th>
                                    <th>Sent At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Email Modal -->
<div class="modal fade" id="addEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Email Channel</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="email-form">
                    <div class="form-group">
                        <label for="email-name">Name:</label>
                        <input type="text" class="form-control" id="email-name" placeholder="My Email Channel">
                    </div>
                    <div class="form-group">
                        <label for="email-smtp">SMTP Server:</label>
                        <input type="text" class="form-control" id="email-smtp" placeholder="smtp.gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label for="email-port">SMTP Port:</label>
                        <input type="number" class="form-control" id="email-port" value="587" required>
                    </div>
                    <div class="form-group">
                        <label for="email-from">From Address:</label>
                        <input type="email" class="form-control" id="email-from" placeholder="alerts@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="email-to">To Address:</label>
                        <input type="email" class="form-control" id="email-to" placeholder="recipient@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="email-username">Username (optional):</label>
                        <input type="text" class="form-control" id="email-username">
                    </div>
                    <div class="form-group">
                        <label for="email-password">Password (optional):</label>
                        <input type="password" class="form-control" id="email-password">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="email-enabled"> Enable immediately
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addEmailChannel()">Add Channel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Webhook Modal -->
<div class="modal fade" id="addWebhookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Webhook Channel</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="webhook-form">
                    <div class="form-group">
                        <label for="webhook-name">Name:</label>
                        <input type="text" class="form-control" id="webhook-name" placeholder="My Webhook">
                    </div>
                    <div class="form-group">
                        <label for="webhook-url">Webhook URL:</label>
                        <input type="url" class="form-control" id="webhook-url" placeholder="https://hooks.slack.com/..." required>
                    </div>
                    <div class="form-group">
                        <label for="webhook-method">Method:</label>
                        <select class="form-control" id="webhook-method">
                            <option value="POST">POST</option>
                            <option value="GET">GET</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="webhook-headers">Headers (JSON, optional):</label>
                        <textarea class="form-control font-monospace" id="webhook-headers" rows="3"
                                  placeholder='{"Authorization": "Bearer token"}'></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="webhook-enabled"> Enable immediately
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addWebhookChannel()">Add Channel</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentChannels = [];

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChannels();
    loadEvents();
});

function loadChannels() {
    fetch('/api/admin/notifications')
        .then(response => response.json())
        .then(data => {
            currentChannels = data;
            renderChannels(data);
        })
        .catch(error => {
            console.error('Error loading channels:', error);
            showError('Failed to load channels');
        });
}

function renderChannels(channels) {
    const tbody = document.querySelector('#channels-table tbody');
    tbody.innerHTML = '';

    if (channels.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No channels configured</td></tr>';
        return;
    }

    channels.forEach(channel => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${channel.id}</td>
            <td>
                <span class="badge badge-${channel.channel_type === 'email' ? 'primary' : 'info'}">
                    ${channel.channel_type.toUpperCase()}
                </span>
            </td>
            <td>
                ${channel.enabled
                    ? '<span class="badge badge-success">Enabled</span>'
                    : '<span class="badge badge-secondary">Disabled</span>'}
            </td>
            <td><pre class="mb-0 text-muted small">${JSON.stringify(channel.config, null, 2)}</pre></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="toggleChannel(${channel.id}, ${!channel.enabled})">
                    ${channel.enabled ? 'Disable' : 'Enable'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteChannel(${channel.id})">
                    Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function loadEvents() {
    fetch('/api/admin/notifications/events?limit=20')
        .then(response => response.json())
        .then(data => {
            renderEvents(data);
        })
        .catch(error => {
            console.error('Error loading events:', error);
        });
}

function renderEvents(events) {
    const tbody = document.querySelector('#events-table tbody');
    tbody.innerHTML = '';

    if (events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No recent events</td></tr>';
        return;
    }

    events.forEach(event => {
        const tr = document.createElement('tr');
        const statusBadge = event.status === 'sent'
            ? '<span class="badge badge-success">Sent</span>'
            : event.status === 'skipped'
            ? '<span class="badge badge-secondary">Skipped</span>'
            : '<span class="badge badge-danger">Error</span>';

        tr.innerHTML = `
            <td>${event.date}</td>
            <td><code>${event.alert_code}</code></td>
            <td>${event.channel_type || 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${event.sent_at || '-'}</td>
        `;
        tbody.appendChild(tr);
    });
}

function addEmailChannel() {
    const name = document.getElementById('email-name').value;
    const smtpServer = document.getElementById('email-smtp').value;
    const smtpPort = document.getElementById('email-port').value;
    const fromAddr = document.getElementById('email-from').value;
    const toAddr = document.getElementById('email-to').value;
    const username = document.getElementById('email-username').value;
    const password = document.getElementById('email-password').value;
    const enabled = document.getElementById('email-enabled').checked;

    const params = new URLSearchParams({
        name: name,
        smtp_server: smtpServer,
        smtp_port: smtpPort,
        from_addr: fromAddr,
        to_addr: toAddr,
        username: username,
        password: password,
        enabled: enabled
    });

    fetch(`/api/admin/notifications/email?${params}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        $('#addEmailModal').modal('hide');
        loadChannels();
        showSuccess('Email channel created successfully');
        // Clear form
        document.getElementById('email-form').reset();
    })
    .catch(error => {
        console.error('Error creating email channel:', error);
        showError('Failed to create email channel');
    });
}

function addWebhookChannel() {
    const name = document.getElementById('webhook-name').value;
    const url = document.getElementById('webhook-url').value;
    const method = document.getElementById('webhook-method').value;
    const headers = document.getElementById('webhook-headers').value.trim();
    const enabled = document.getElementById('webhook-enabled').checked;

    const params = new URLSearchParams({
        name: name,
        url: url,
        method: method,
        enabled: enabled
    });
    if (headers) params.append('headers', headers);

    fetch(`/api/admin/notifications/webhook?${params}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        $('#addWebhookModal').modal('hide');
        loadChannels();
        showSuccess('Webhook channel created successfully');
        // Clear form
        document.getElementById('webhook-form').reset();
    })
    .catch(error => {
        console.error('Error creating webhook channel:', error);
        showError('Failed to create webhook channel');
    });
}

function toggleChannel(channelId, enabled) {
    const params = new URLSearchParams({
        enabled: enabled
    });

    fetch(`/api/admin/notifications/${channelId}/toggle?${params}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        loadChannels();
        showSuccess(`Channel ${enabled ? 'enabled' : 'disabled'}`);
    })
    .catch(error => {
        console.error('Error toggling channel:', error);
        showError('Failed to toggle channel');
    });
}

function deleteChannel(channelId) {
    if (!confirm('Are you sure you want to delete this channel?')) return;

    fetch(`/api/admin/notifications/${channelId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        loadChannels();
        showSuccess('Channel deleted');
    })
    .catch(error => {
        console.error('Error deleting channel:', error);
        showError('Failed to delete channel');
    });
}

function showSuccess(message) {
    alert(message);
}

function showError(message) {
    alert(message);
}
</script>

<style>
.font-monospace {
    font-family: 'Courier New', Courier, monospace;
}
</style>
{% endblock %}
